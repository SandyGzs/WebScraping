"""
Objective: finding all store contact informations for any store in 
(1) "https://www.yiwugo.com/shop_list/i_1_1003.html" China Yiwu International Trade City Phase III
(2) "https://www.yiwugo.com/shop_list/i_1_1001.html" China Yiwu International Trade City Phase I 3rd & 4th floor 

It's very easy to see that the url is in the format f"https://www.yiwugo.com/shop_list/i_1_100{floor_number}" where floor number can be 1, 2, 3 or more.

Difficulty:
(1) if visiting speed is faster than 4s per refresh, browser is located and forced login + text verification are triggered [future goals]
(2) limited search results: i. search subpages ii. find open api endpoints

Please prepare the setup of DrissionPage and Chrome
"""

# Version I
# Import Packages
from DrissionPage import ChromiumPage, ChromiumOptions 
import pandas as pd
from tqdm import tqdm
import re

# Prepare Chrome
co = ChromiumOptions().auto_port()
co.headless()
driver = ChromiumPage(co)

# Choose which url groups you need - let's use Objective (2) as an example
driver.get("https://www.yiwugo.com/shop_list/i_1_1001.html")
urls = [ 
    ele.attr("href")
    for ele in driver.s_ele(".markets-wrap").children() 
    if ele.attr("href") and re.compile(r"https://www.yiwugo.com/shop_list/i_1_1001_(3|4)").match(ele.attr("href")) 
]


# Core Action: Get Data
def getData(chrome_driver):
    driver.wait.ele_loaded(".shop-list")
    return pd.DataFrame([
        {"title": pic.s_ele(".shop-name").attr("title"), "href": pic.s_ele(".shop-name").attr("href")} 
        for pic in driver.s_ele(".shop-list").children() 
        if pic.attr("class") == 'pro_list_company_img'
    ])


# Start WebScraping
dfs = []
for url in tqdm(urls):
    driver.get(url)
    driver.wait.ele_loaded(".ant-pagination-simple-pager")
    pages = driver.s_ele(".ant-pagination-simple-pager")
    pages = int(driver.s_ele(".ant-pagination-simple-pager").attr("title").split("/")[1]) - 1 if pages else 0
    dfs.append(getData(driver))
    if pages > 1:
        for _ in range(pages):
            driver.wait(5)
            driver.wait.ele_loaded(". ant-pagination-next")
            driver.ele(". ant-pagination-next").click()
            dfs.append(getData(driver))

pd.concat(dfs).to_csv("ywg_targets.csv", index=False)
driver.quit()
